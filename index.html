<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5/3/1 Forever AI Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
        }

        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 0.75rem;
        }

        .input-dark {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: white;
        }

        .input-dark:focus {
            outline: none;
            border-color: #e11d48;
            ring: 1px solid #e11d48;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #121212; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #e11d48; 
        }

        .tab-active {
            border-bottom: 2px solid #e11d48;
            color: #e11d48;
        }
        
        .tab-inactive {
            color: #888;
        }
        
        .tab-inactive:hover {
            color: #ccc;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tag-leader {
            background-color: #065f46;
            color: #6ee7b7;
        }
        .tag-anchor {
            background-color: #9f1239;
            color: #fda4af;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <!-- Header -->
    <header class="text-center mb-8 max-w-2xl w-full">
        <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">5/3/1 <span class="text-rose-600">FOREVER</span></h1>
        <p class="text-gray-400 text-sm">Leader/Anchor Programming Logic</p>
        <p class="text-gray-500 text-xs mt-1">Updated: Clear Math Explanation</p>
    </header>

    <!-- Main App Container -->
    <main class="w-full max-w-5xl space-y-6">

        <!-- INSTRUCTIONS PANEL -->
        <section class="bg-gray-800 border border-gray-700 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('instructionsBody').classList.toggle('hidden')">
                <h3 class="text-sm font-bold text-rose-400 uppercase tracking-wide flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    How to use this program (Step-by-Step)
                </h3>
                <span class="text-gray-500 text-xs">Click to toggle</span>
            </div>
            <div id="instructionsBody" class="mt-3 text-sm text-gray-300 space-y-3 hidden">
                <div class="border-l-4 border-emerald-600 pl-3">
                    <h4 class="font-bold text-white mb-1">Phase 1: The LEADER (6 Weeks)</h4>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>Step 1:</strong> Enter 1RMs and click <span class="text-rose-400 font-bold">"CALCULATE STARTING WEIGHTS"</span>. Ensure "Leader" is active.</li>
                        <li><strong>Step 2:</strong> Complete Week 1, 2, and 3 workouts.</li>
                        <li><strong>Step 3:</strong> Click <span class="text-emerald-400 font-bold">"Complete Cycle (+kg)"</span>. Your weights increase.</li>
                        <li><strong>Step 4:</strong> Complete Week 1, 2, and 3 again (Cycle 2).</li>
                        <li><strong>Step 5:</strong> Click <span class="text-emerald-400 font-bold">"Complete Cycle (+kg)"</span> again.</li>
                    </ul>
                </div>
                
                <div class="border-l-4 border-yellow-600 pl-3">
                    <h4 class="font-bold text-white mb-1">Phase 2: The DELOAD (1 Week)</h4>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>Step 6:</strong> Click the <strong>"7th Week Protocol"</strong> tab. Select "Deload".</li>
                        <li><strong>Step 7:</strong> Perform the Deload workouts for one week. Do not increase weights.</li>
                    </ul>
                </div>

                <div class="border-l-4 border-rose-600 pl-3">
                    <h4 class="font-bold text-white mb-1">Phase 3: The ANCHOR (3 Weeks)</h4>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>Step 8:</strong> Click the <strong>"Anchor"</strong> button at the top. <span class="text-rose-400 italic">Do NOT click "Calculate Starting Weights" again!</span></li>
                        <li><strong>Step 9:</strong> Complete Weeks 1, 2, and 3. Push for PRs on main sets.</li>
                        <li><strong>Step 10:</strong> Click <span class="text-emerald-400 font-bold">"Complete Cycle (+kg)"</span> to finish the macrocycle.</li>
                    </ul>
                </div>

                <div class="border-l-4 border-blue-500 pl-3">
                    <h4 class="font-bold text-white mb-1">Phase 4: The TM TEST & RESET (1 Week)</h4>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>Step 11:</strong> Go to "7th Week Protocol" tab again. Select <strong>"TM Test"</strong>.</li>
                        <li><strong>Step 12:</strong> Perform your test. Enter your reps in the <strong>"Reps Achieved"</strong> box.</li>
                        <li><strong>Step 13:</strong> Click <strong>"Update 1RM"</strong>. The system will reverse-calculate the input needed to give you the correct +2.5kg/+5kg progression.</li>
                        <li><strong>Step 14:</strong> Switch back to <strong>"Leader"</strong> and click <strong>"CALCULATE STARTING WEIGHTS"</strong> to restart at Step 1 with your NEW numbers.</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- User Stats Input Section -->
        <section id="setupSection" class="card p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Program Setup
                </h2>
                <div class="text-xs text-gray-500">Inputs in KG (Rounding: 2.5kg)</div>
            </div>

            <!-- Forever Specific Settings -->
            <div class="mb-6 p-4 bg-gray-800 rounded-lg border border-gray-700">
                <div class="flex flex-col md:flex-row gap-6 mb-4">
                    <div class="flex-1">
                        <label class="block text-gray-300 text-sm font-bold mb-2">Phase Type</label>
                        <div class="flex bg-gray-700 rounded p-1">
                            <button onclick="setPhase('leader')" id="btnLeader" class="flex-1 py-2 rounded text-sm font-bold transition-colors bg-emerald-700 text-white">Leader</button>
                            <button onclick="setPhase('anchor')" id="btnAnchor" class="flex-1 py-2 rounded text-sm font-bold transition-colors text-gray-400 hover:text-white">Anchor</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1" id="phaseDesc">High volume, no PR sets. Build the base.</p>
                    </div>
                    <div class="flex-1">
                        <label class="block text-gray-300 text-sm font-bold mb-2">Main Lift Style</label>
                        <!-- Added ONCHANGE for instant updates -->
                        <select id="mainLiftStyle" onchange="updateConfig()" class="input-dark w-full p-2 rounded text-sm">
                            <option value="5s_pro">5's PRO (5 reps all sets, No PR)</option>
                            <option value="original">Original 5/3/1 (PR Sets)</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-700">
                    <div>
                        <label class="block text-gray-400 text-xs mb-1">Supplemental Scheme</label>
                        <!-- Added ONCHANGE for instant updates -->
                        <select id="supplemental" onchange="updateConfig()" class="input-dark w-full p-2 rounded text-sm">
                            <option value="bbb_fsl">Forever BBB - Progressive (FSL %)</option>
                            <option value="bbb_50">Forever BBB - Static (50%)</option>
                            <option value="bbb_60">Forever BBB - Static (60%)</option>
                            <option value="bbs">Boring But Strong (10x5 @ FSL)</option>
                            <option value="ssl">Second Set Last (5x5 @ SSL)</option>
                            <option value="fsl">First Set Last (5x5 @ FSL)</option>
                            <option value="none">None (Main Work Only)</option>
                        </select>
                        <p class="text-[10px] text-gray-500 mt-1">"Progressive" gets heavier each week. "Static" stays same.</p>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-1">Training Max % (Reset Only)</label>
                        <select id="tmPercentage" class="input-dark w-full p-2 rounded text-sm">
                            <option value="0.85">85% (Forever Recommended)</option>
                            <option value="0.9">90% (Original)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-400 uppercase">Squat 1RM</label>
                    <input type="number" id="squatMax" class="input-dark w-full p-3 rounded text-center text-lg font-bold" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-400 uppercase">Bench 1RM</label>
                    <input type="number" id="benchMax" class="input-dark w-full p-3 rounded text-center text-lg font-bold" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-400 uppercase">Deadlift 1RM</label>
                    <input type="number" id="deadliftMax" class="input-dark w-full p-3 rounded text-center text-lg font-bold" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-semibold text-gray-400 uppercase">Press 1RM</label>
                    <input type="number" id="pressMax" class="input-dark w-full p-3 rounded text-center text-lg font-bold" placeholder="0">
                </div>
            </div>

            <button id="btnGenerate" onclick="generateProgram()" class="w-full mt-6 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 rounded transition-all shadow-lg shadow-rose-900/50">
                CALCULATE STARTING WEIGHTS (RESET)
            </button>
            <p class="text-center text-xs text-gray-500 mt-2">Only click this when starting a brand new program (Cycle 1).</p>
        </section>

        <!-- Program Output Section -->
        <section id="programSection" class="hidden animate-fade-in space-y-6">
            
            <!-- Cycle Info & Controls -->
            <div class="flex flex-col md:flex-row justify-between items-end border-b border-gray-700 pb-4">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center gap-3">
                        <h3 class="text-2xl font-bold text-white">Cycle <span id="cycleCount">1</span></h3>
                        <span id="cycleTag" class="text-xs px-2 py-1 rounded font-bold uppercase tracking-wide"></span>
                    </div>
                    <div class="flex gap-4 text-sm text-gray-400 mt-1">
                        <span>TM Squat: <b id="tmSquat" class="text-rose-400"></b>kg</span>
                        <span>TM Bench: <b id="tmBench" class="text-rose-400"></b>kg</span>
                        <span>TM Dead: <b id="tmDead" class="text-rose-400"></b>kg</span>
                        <span>TM Press: <b id="tmPress" class="text-rose-400"></b>kg</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <!-- Fixed Button -->
                    <button id="nextCycleBtn" onclick="nextCycle()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm font-semibold transition-colors flex items-center gap-2">
                        Complete Cycle (+kg)
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Weekly Tabs -->
            <div class="flex space-x-6 overflow-x-auto pb-2" id="weekTabs">
                <button onclick="switchWeek(1)" id="tab1" class="tab-active text-lg font-bold pb-2 transition-colors whitespace-nowrap">Week 1</button>
                <button onclick="switchWeek(2)" id="tab2" class="tab-inactive text-lg font-bold pb-2 transition-colors whitespace-nowrap">Week 2</button>
                <button onclick="switchWeek(3)" id="tab3" class="tab-inactive text-lg font-bold pb-2 transition-colors whitespace-nowrap">Week 3</button>
                <button onclick="switchWeek(4)" id="tab4" class="tab-inactive text-lg font-bold pb-2 transition-colors whitespace-nowrap text-rose-500">7th Week Protocol</button>
            </div>

            <!-- 7th Week Protocol Selector (Only visible on week 4) -->
            <div id="protocolSelector" class="hidden bg-gray-800 p-4 rounded mb-4 border border-gray-700">
                <label class="text-sm font-bold text-gray-300 mr-3">7th Week Protocol Type:</label>
                <select id="protocolType" onchange="renderWeek(4)" class="input-dark p-1 rounded text-sm">
                    <option value="deload">Standard Deload (Recovery)</option>
                    <option value="tm_test">TM Test (3-5 reps @ 100% TM)</option>
                    <option value="pr_test">PR Test (AMRAP @ 100% TM)</option>
                </select>
                <p class="text-xs text-gray-500 mt-2" id="protocolDesc">Work up to a single at TM. Low stress.</p>
            </div>

            <!-- Workouts Grid -->
            <div id="workoutsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Workout Cards Generated Here -->
            </div>

        </section>

    </main>

    <footer class="mt-12 text-center text-gray-600 text-xs">
        <p>AI Generated Coach based on Jim Wendler's "5/3/1 Forever".</p>
    </footer>

    <script>
        // Global State
        let state = {
            cycle: 1,
            lifts: { squat: 0, bench: 0, deadlift: 0, press: 0 },
            tm: { squat: 0, bench: 0, deadlift: 0, press: 0 },
            config: {
                rounding: 2.5,
                tmPercentage: 0.85,
                phase: 'leader', // leader or anchor
                mainLiftStyle: '5s_pro', // 5s_pro or original
                supplemental: 'bbb_fsl', // Defaulted to Progressive
                protocol7: 'deload'
            }
        };

        // Accessory Exercise Database
        // Organized by Goal/Day to optimize split
        const accessories = {
            squatDay: {
                push: [
                    { name: "Tricep Pushdowns", reps: "3 x 15-20" },
                    { name: "Overhead Tricep Ext", reps: "3 x 12-15" },
                    { name: "Skullcrushers", reps: "3 x 10-12" }
                ],
                pull: [
                    { name: "Chin-ups / Pull-ups", reps: "3 x 5-10" },
                    { name: "Lat Pulldowns", reps: "3 x 10-12" }
                ],
                core: [
                    { name: "Hanging Leg Raises", reps: "3 x 10-15" },
                    { name: "Toes to Bar", reps: "3 x 8-10" },
                    { name: "Lying Leg Raises", reps: "3 x 15-20" }
                ]
            },
            benchDay: {
                push: [
                    { name: "Close Grip Bench", reps: "3 x 8-10" },
                    { name: "DB Incline Press", reps: "3 x 10-12" },
                    { name: "Push-ups", reps: "3 x AMRAP" }
                ],
                pull: [
                    { name: "DB Rows", reps: "3 x 10-15" },
                    { name: "Chest Supported Rows", reps: "3 x 10-12" },
                    { name: "Cable Rows", reps: "3 x 12-15" }
                ],
                core: [
                    { name: "Bulgarian Split Squats", reps: "3 x 8-10 leg" },
                    { name: "Walking Lunges", reps: "3 x 20 steps" },
                    { name: "Reverse Lunges", reps: "3 x 10 leg" }
                ]
            },
            deadliftDay: {
                push: [
                    { name: "Push-ups", reps: "3 x AMRAP" },
                    { name: "DB Floor Press", reps: "3 x 10-12" }
                ],
                pull: [
                    { name: "Face Pulls", reps: "3 x 20" },
                    { name: "Band Pull-Aparts", reps: "3 x 25" }
                ],
                core: [
                    { name: "Planks", reps: "3 x 60s" },
                    { name: "Side Planks", reps: "3 x 30s side" },
                    { name: "Ab Wheel Rollouts", reps: "3 x 10-12" }
                ]
            },
            pressDay: {
                push: [
                    { name: "Dips (Weighted or BW)", reps: "3 x 10-15" }
                ],
                pull: [
                    { name: "Lat Pulldowns", reps: "3 x 10-12" },
                    { name: "Chin-ups", reps: "3 x AMRAP" }
                ],
                core: [
                    { name: "Back Extensions", reps: "3 x 15" },
                    { name: "Kettlebell Swings", reps: "3 x 15-20" },
                    { name: "Step Ups", reps: "3 x 10 leg" }
                ]
            }
        };

        // NEW: Function to handle instant updates to settings without resetting TM
        function updateConfig() {
            // Read inputs
            state.config.mainLiftStyle = document.getElementById('mainLiftStyle').value;
            state.config.supplemental = document.getElementById('supplemental').value;
            // Note: We deliberately do NOT update TM Percentage here as that requires a recalculation
            
            // Refresh View
            const activeTab = document.querySelector('.tab-active') ? document.querySelector('.tab-active').id.replace('tab', '') : 1;
            renderWeek(parseInt(activeTab));
        }

        // Logic for Phase Switching (UPDATED)
        function setPhase(phase) {
            state.config.phase = phase;
            
            // Visual Updates
            const btnLeader = document.getElementById('btnLeader');
            const btnAnchor = document.getElementById('btnAnchor');
            const phaseDesc = document.getElementById('phaseDesc');
            const mainLiftSelect = document.getElementById('mainLiftStyle');
            const suppSelect = document.getElementById('supplemental');

            if (phase === 'leader') {
                btnLeader.className = 'flex-1 py-2 rounded text-sm font-bold transition-colors bg-emerald-700 text-white';
                btnAnchor.className = 'flex-1 py-2 rounded text-sm font-bold transition-colors text-gray-400 hover:text-white';
                phaseDesc.innerText = "Higher volume, lower intensity. Build the base. Recommend 5's PRO.";
                
                // Set Recommended Defaults for Leader
                mainLiftSelect.value = '5s_pro';
                suppSelect.value = 'bbb_fsl'; 
            } else {
                btnAnchor.className = 'flex-1 py-2 rounded text-sm font-bold transition-colors bg-rose-700 text-white';
                btnLeader.className = 'flex-1 py-2 rounded text-sm font-bold transition-colors text-gray-400 hover:text-white';
                phaseDesc.innerText = "Lower volume, higher intensity (PR Sets). Realize strength. Recommend FSL.";
                
                // Set Recommended Defaults for Anchor
                mainLiftSelect.value = 'original';
                suppSelect.value = 'fsl'; 
            }
            
            // Trigger config update to apply these new defaults
            updateConfig();
            updateTMDisplay();
        }

        // Rounding Helper - MODIFIED FOR 2.5KG PLATE MATH
        function mRound(weight, increment) {
            // Default increment to 2.5 if not provided
            const inc = increment || 2.5; 
            return Math.round(weight / inc) * inc;
        }
        function fmt(weight) {
            // Ensure visual consistency
            return weight % 1 === 0 ? weight : weight.toFixed(1);
        }

        let resetConfirmationPending = false;

        // Generate Program (INITIAL SETUP - RESET)
        function generateProgram() {
            const btn = document.getElementById('btnGenerate');
            
            // Safety Check for Cycle > 1 with "Click Again" logic
            if(state.cycle > 1 && !resetConfirmationPending) {
                resetConfirmationPending = true;
                btn.innerText = "⚠️ CONFIRM RESET? (CLICK AGAIN)";
                btn.className = "w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded transition-all shadow-lg animate-pulse";
                
                // Reset timeout after 3 seconds
                setTimeout(() => {
                    resetConfirmationPending = false;
                    btn.innerText = "CALCULATE STARTING WEIGHTS (RESET)";
                    btn.className = "w-full mt-6 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 rounded transition-all shadow-lg shadow-rose-900/50";
                }, 3000);
                return;
            }

            // Execute Reset
            resetConfirmationPending = false;
            btn.innerText = "CALCULATE STARTING WEIGHTS (RESET)";
            btn.className = "w-full mt-6 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 rounded transition-all shadow-lg shadow-rose-900/50";

            state.cycle = 1; // Reset cycle count
            state.lifts.squat = parseFloat(document.getElementById('squatMax').value) || 0;
            state.lifts.bench = parseFloat(document.getElementById('benchMax').value) || 0;
            state.lifts.deadlift = parseFloat(document.getElementById('deadliftMax').value) || 0;
            state.lifts.press = parseFloat(document.getElementById('pressMax').value) || 0;

            state.config.tmPercentage = parseFloat(document.getElementById('tmPercentage').value);
            // Apply current dropdown settings
            updateConfig(); 

            // Calculate Initial Training Maxes
            state.tm.squat = state.lifts.squat * state.config.tmPercentage;
            state.tm.bench = state.lifts.bench * state.config.tmPercentage;
            state.tm.deadlift = state.lifts.deadlift * state.config.tmPercentage;
            state.tm.press = state.lifts.press * state.config.tmPercentage;

            if (state.tm.squat === 0 && state.tm.bench === 0 && state.tm.deadlift === 0) {
                alert("Please enter at least one 1RM.");
                return;
            }

            updateTMDisplay();
            programSection.classList.remove('hidden');
            switchWeek(1);
            programSection.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('instructionsBody').classList.remove('hidden');
        }

        function updateTMDisplay() {
            document.getElementById('cycleCount').innerText = state.cycle;
            const tag = document.getElementById('cycleTag');
            if(state.config.phase === 'leader') {
                tag.innerText = "LEADER";
                tag.className = "text-xs px-2 py-1 rounded font-bold uppercase tracking-wide tag-leader";
            } else {
                tag.innerText = "ANCHOR";
                tag.className = "text-xs px-2 py-1 rounded font-bold uppercase tracking-wide tag-anchor";
            }

            document.getElementById('tmSquat').innerText = fmt(mRound(state.tm.squat, 2.5));
            document.getElementById('tmBench').innerText = fmt(mRound(state.tm.bench, 2.5));
            document.getElementById('tmDead').innerText = fmt(mRound(state.tm.deadlift, 2.5));
            document.getElementById('tmPress').innerText = fmt(mRound(state.tm.press, 2.5));
        }

        function nextCycle() {
            // 1. Update State
            state.cycle++;
            state.tm.squat += 5;
            state.tm.deadlift += 5;
            state.tm.bench += 2.5;
            state.tm.press += 2.5;

            // 2. Update UI Text
            updateTMDisplay();

            // 3. Re-render and switch to Week 1
            switchWeek(1);

            // 4. Visual Feedback on Button
            const btn = document.getElementById('nextCycleBtn');
            const originalText = `Complete Cycle (+kg) <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>`;
            
            btn.innerHTML = `Cycle ${state.cycle} Started! ✓`;
            btn.className = "bg-emerald-600 text-white px-4 py-2 rounded text-sm font-bold transition-colors flex items-center gap-2";
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.className = "bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm font-semibold transition-colors flex items-center gap-2";
            }, 2000);
        }

        function switchWeek(weekNum) {
            [1,2,3,4].forEach(n => {
                const btn = document.getElementById(`tab${n}`);
                if(n === weekNum) {
                    btn.classList.remove('tab-inactive');
                    btn.classList.add('tab-active');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('tab-inactive');
                }
            });

            // Show/Hide 7th week protocol selector
            const protocolSel = document.getElementById('protocolSelector');
            if(weekNum === 4) {
                protocolSel.classList.remove('hidden');
            } else {
                protocolSel.classList.add('hidden');
            }

            renderWeek(weekNum);
        }

        // Helper: Day-Aware Accessory Selection
        function getAccessories(liftName, weekNum) {
            const seed = (state.cycle * 13) + (weekNum * 7) + liftName.length;

            let pool;
            if(liftName === 'Squat') pool = accessories.squatDay;
            else if(liftName === 'Bench Press') pool = accessories.benchDay;
            else if(liftName === 'Deadlift') pool = accessories.deadliftDay;
            else pool = accessories.pressDay;

            // Pick based on seed
            return {
                push: pool.push[seed % pool.push.length],
                pull: pool.pull[(seed + 1) % pool.pull.length],
                core: pool.core[(seed + 2) % pool.core.length],
                label: (liftName === 'Bench Press' || liftName === 'Overhead Press') ? 'LEG/CORE' : 'ABS/CORE'
            };
        }

        function renderWeek(week) {
            workoutsContainer.innerHTML = '';
            
            // Order: Squat, Bench, Deadlift, Press
            const lifts = [
                { name: 'Squat', tm: state.tm.squat, type: 'lower' },
                { name: 'Bench Press', tm: state.tm.bench, type: 'upper' },
                { name: 'Deadlift', tm: state.tm.deadlift, type: 'lower' },
                { name: 'Overhead Press', tm: state.tm.press, type: 'upper' }
            ];

            // Update 7th week desc if needed
            if(week === 4) {
                const type = document.getElementById('protocolType').value;
                const desc = document.getElementById('protocolDesc');
                if(type === 'deload') desc.innerText = "Standard Deload: 70%x5, 80%x3-5, 90%x1, 100%x1. No supplemental.";
                if(type === 'tm_test') desc.innerText = "TM Test: 70%x5, 80%x5, 90%x5, 100%x3-5. Solid reps only.";
                if(type === 'pr_test') desc.innerText = "PR Test: 70%x5, 80%x5, 90%x5, 100%x AMRAP.";
            }

            lifts.forEach(lift => {
                if(lift.tm > 0) {
                    workoutsContainer.innerHTML += createWorkoutCard(lift, week);
                }
            });
        }

        // New Helper: Calculate 1RM from TM and Reps
        window.calculateNewMax = function(liftName, tmWeight) {
            // liftName in card has spaces (e.g. "Overhead Press"), input IDs are specific
            let inputId = '';
            if(liftName === 'Squat') inputId = 'squatMax';
            else if(liftName === 'Bench Press') inputId = 'benchMax';
            else if(liftName === 'Deadlift') inputId = 'deadliftMax';
            else if(liftName === 'Overhead Press') inputId = 'pressMax';

            // Get Reps Input
            const safeName = liftName.replace(/\s+/g, '');
            const repInputId = `reps_${safeName}`;
            const reps = parseFloat(document.getElementById(repInputId).value) || 0;

            if(reps === 0) {
                alert("Please enter the number of reps you performed.");
                return;
            }

            const inputEl = document.getElementById(inputId);
            const tmPct = parseFloat(document.getElementById('tmPercentage').value) || 0.85;

            // LOGIC FOR WENDLER TM TEST:
            // If Reps >= 3: You pass. Increase TM by standard amount (2.5/5kg).
            // We need to reverse engineer the 1RM input so that (Input * pct) = (OldTM + Inc)
            
            const isUpper = liftName === 'Bench Press' || liftName === 'Overhead Press';
            const increment = isUpper ? 2.5 : 5.0;

            if (reps >= 3) {
                // PASS: Standard Progression
                // New TM = Old TM + Increment
                const targetTM = tmWeight + increment;
                
                // Calculate required 1RM input to hit this target TM
                // Input * tmPct = targetTM  =>  Input = targetTM / tmPct
                const requiredInput = targetTM / tmPct;
                const roundedInput = mRound(requiredInput, 2.5);

                if(inputEl) {
                    inputEl.value = roundedInput;
                    inputEl.classList.add('ring', 'ring-emerald-500');
                    setTimeout(() => inputEl.classList.remove('ring', 'ring-emerald-500'), 1000);
                }
                
                alert(`TEST PASSED (${reps} Reps)!\n\nStandard progression applied (+${increment}kg to TM).\n\nWhy did the Input Box jump?\nWe set your Input 1RM to ${roundedInput}kg so that when multiplied by ${tmPct*100}%, it equals your NEW Training Max of ${targetTM}kg.\n\nClick RESET above to start the new block.`);
            
            } else {
                // FAIL: Regress
                // Formula: Estimated 1RM = Weight * (1 + reps/30)
                const estMax = tmWeight * (1 + reps/30);
                const roundedMax = mRound(estMax, 2.5);
                
                if(inputEl) {
                    inputEl.value = roundedMax;
                    inputEl.classList.add('ring', 'ring-red-500');
                    setTimeout(() => inputEl.classList.remove('ring', 'ring-red-500'), 1000);
                }
                alert(`TEST FAILED (< 3 Reps).\n\nYour Training Max was too high. Your 1RM input has been lowered to ${roundedMax}kg based on your performance.\n\nClick RESET above to recalibrate.`);
            }
        }

        function createWorkoutCard(lift, week) {
            const tm = lift.tm;
            // HARDCODED ROUNDING TO 2.5 FOR EVERYTHING
            const round = 2.5;
            const is5sPro = state.config.mainLiftStyle === '5s_pro';
            
            // Main Work Logic
            let sets = [];
            let reps = [];
            let isTmTest = false;
            
            // 7th Week Protocol Handling
            if (week === 4) {
                const protocol = document.getElementById('protocolType').value;
                if (protocol === 'deload') {
                    sets = [0.70, 0.80, 0.90, 1.0];
                    reps = ["5", "3-5", "1", "1"];
                } else if (protocol === 'tm_test') {
                    sets = [0.70, 0.80, 0.90, 1.0];
                    reps = ["5", "5", "5", "3-5 (Test)"];
                    isTmTest = true;
                } else {
                    sets = [0.70, 0.80, 0.90, 1.0];
                    reps = ["5", "5", "5", "PR Set"];
                }
            } else {
                // Standard Weeks
                if (week === 1) {
                    sets = [0.65, 0.75, 0.85];
                    reps = is5sPro ? ["5", "5", "5"] : ["5", "5", "5+"];
                } else if (week === 2) {
                    sets = [0.70, 0.80, 0.90];
                    reps = is5sPro ? ["5", "5", "5"] : ["3", "3", "3+"];
                } else if (week === 3) {
                    sets = [0.75, 0.85, 0.95];
                    reps = is5sPro ? ["5", "5", "5"] : ["5", "3", "1+"];
                }
            }

            const workSetsHtml = sets.map((pct, idx) => {
                const weight = fmt(mRound(tm * pct, round));
                // Only highlight PR set if it IS a PR set (not 5s PRO)
                const isPr = !is5sPro && idx === 2 && week !== 4;
                
                return `
                    <div class="flex justify-between border-b border-gray-800 pb-1 mb-1 border-transparent rounded px-1 ${isPr ? 'bg-rose-900/20' : ''}">
                        <span class="text-gray-300">${(pct*100).toFixed(0)}%</span>
                        <span class="font-mono text-gray-400">
                            ${weight}kg x ${reps[idx]}
                            ${isPr ? '<span class="text-[10px] text-rose-400 font-bold ml-2">PR SET</span>' : ''}
                        </span>
                    </div>
                `;
            }).join('');

            // TM Test Calculator Injector
            let calculatorHtml = '';
            if (isTmTest) {
                const safeName = lift.name.replace(/\s+/g, '');
                calculatorHtml = `
                    <div class="mt-4 p-3 bg-gray-800 border border-blue-900 rounded">
                        <label class="block text-[10px] text-blue-300 font-bold uppercase mb-1">TM Test Calculator</label>
                        <div class="flex gap-2">
                            <input type="number" id="reps_${safeName}" class="w-16 input-dark p-1 text-center text-sm rounded" placeholder="Reps">
                            <button onclick="calculateNewMax('${lift.name}', ${tm})" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold rounded">
                                Update 1RM
                            </button>
                        </div>
                    </div>
                `;
            }

            // Supplemental Logic (Not done on Week 4)
            let supplementalHtml = '';
            if (week !== 4 && state.config.supplemental !== 'none') {
                let scheme = state.config.supplemental;
                let suppWeight = 0;
                let suppSetsReps = "";
                let suppName = "";

                // Determine FSL Weight (This changes week to week: 65% -> 70% -> 75%)
                const fslPct = week === 1 ? 0.65 : (week === 2 ? 0.70 : 0.75);
                const fslWeight = fmt(mRound(tm * fslPct, round));
                
                // Determine SSL Weight
                const sslPct = week === 1 ? 0.75 : (week === 2 ? 0.80 : 0.85);
                const sslWeight = fmt(mRound(tm * sslPct, round));

                if (scheme.startsWith('bbb')) {
                    suppName = "Forever BBB";
                    let pct = 0.50;
                    
                    if(scheme === 'bbb_40') pct = 0.40;
                    if(scheme === 'bbb_60') pct = 0.60;
                    
                    if(scheme === 'bbb_fsl') {
                        pct = fslPct; // Use the progressive percentage
                        suppWeight = fslWeight;
                    } else {
                        suppWeight = fmt(mRound(tm * pct, round));
                    }
                    
                    suppSetsReps = `5 x 10 @ ${suppWeight}kg (${(pct*100).toFixed(0)}%)`;
                } else if (scheme === 'bbs') {
                    suppName = "Boring But Strong";
                    suppSetsReps = `10 x 5 @ ${fslWeight}kg (FSL)`;
                } else if (scheme === 'fsl') {
                    suppName = "First Set Last";
                    suppSetsReps = `5 x 5 @ ${fslWeight}kg (FSL)`;
                } else if (scheme === 'ssl') {
                    suppName = "Second Set Last";
                    suppSetsReps = `5 x 5 @ ${sslWeight}kg (SSL)`;
                }

                supplementalHtml = `
                    <div class="mt-4 pt-2 border-t border-gray-700">
                        <div class="text-xs text-emerald-400 font-bold uppercase mb-1">${suppName}</div>
                        <div class="text-sm text-white font-mono">${suppSetsReps}</div>
                    </div>
                `;
            }

            // Updated Forever Assistance (Intelligent Rotation with Leader/Anchor logic)
            let assistanceHtml = '';
            if(week !== 4) {
                const acc = getAccessories(lift.name, week);
                
                // Determine Total Reps based on Phase
                const totalReps = state.config.phase === 'leader' ? "25-50" : "50-100";
                
                // Calculate Sets x Reps based on totalReps target
                const calcSetsReps = (range) => {
                    if (state.config.phase === 'leader') return "3 x 10-15"; // Conservative for Leader
                    return "5 x 10-20"; // Aggressive for Anchor
                };

                assistanceHtml = `
                    <div class="mt-4 pt-2 border-t border-gray-700">
                        <div class="text-xs text-blue-400 font-bold uppercase mb-2">Accessory Work (${totalReps} reps total)</div>
                        <div class="space-y-2 text-sm text-gray-300">
                            <div class="flex justify-between items-center bg-gray-800/50 p-2 rounded border border-gray-700">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold bg-gray-700 px-1.5 py-0.5 rounded text-gray-400">PUSH</span>
                                    <span>${acc.push.name}</span>
                                </div>
                                <div class="font-mono text-gray-400 text-xs">${calcSetsReps(acc.push.reps)}</div>
                            </div>
                            <div class="flex justify-between items-center bg-gray-800/50 p-2 rounded border border-gray-700">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold bg-gray-700 px-1.5 py-0.5 rounded text-gray-400">PULL</span>
                                    <span>${acc.pull.name}</span>
                                </div>
                                <div class="font-mono text-gray-400 text-xs">${calcSetsReps(acc.pull.reps)}</div>
                            </div>
                            <div class="flex justify-between items-center bg-gray-800/50 p-2 rounded border border-gray-700">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-bold bg-gray-700 px-1.5 py-0.5 rounded text-gray-400">${acc.label}</span>
                                    <span>${acc.core.name}</span>
                                </div>
                                <div class="font-mono text-gray-400 text-xs">${calcSetsReps(acc.core.reps)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="card p-5 relative">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="text-xl font-bold text-white">${lift.name}</h4>
                        <div class="text-xs text-gray-500 font-mono">TM: ${tm}kg</div>
                    </div>
                    <div class="space-y-1">
                        ${workSetsHtml}
                        ${calculatorHtml}
                    </div>
                    ${supplementalHtml}
                    ${assistanceHtml}
                </div>
            `;
        }
    </script>
</body>
</html>
